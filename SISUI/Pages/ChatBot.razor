@page "/chatbot"
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop

<div class="chat-outer">
    <div class="chat-container">
       <div class="chat-header">
         @*    <img src=" ~ /abb-logo.svg"  alt="Logo" style="height:32px;width:32px;margin-right:8px;" /> *@
            <span class="chat-title">CoEngineer - Signal Intelligence System</span>
        </div>

        <div class="chat-messages">
            @for (int i = 0; i < Messages.Count; i++)
            {
                <div class="chat-row @(Messages[i].IsUser ? "chat-user" : "chat-assistant")">
                    <div class="chat-avatar">
                        <span class="avatar-icon">@(Messages[i].IsUser ? "🧑" : "🤖")</span>
                    </div>
                    <div class="chat-bubble">@Messages[i].Text</div>
                </div>
            }
            @if (IsWaitingForResult)
            {
                <div class="chat-row chat-assistant">
                    <div class="chat-avatar"><span class="avatar-icon">🤖</span></div>
                    <div class="chat-bubble chat-spinner">
                        <span class="spinner-border spinner-border-sm text-primary"></span>
                        <span class="ms-2">Generating signal list, please wait...</span>
                    </div>
                </div>
            }
        </div>

        <div class="chat-input-row">
            <EditForm Model="@UserInputModel" OnValidSubmit="@SendMessage">
                <div class="chat-input-flex">
                    <InputText @bind-Value="UserInputModel.Text"
                               class="form-control chat-input"
                               placeholder="Type your message..."
                               disabled="@IsWaitingForResult" />
                    <button type="submit" class="btn btn-primary chat-send-btn" disabled="@IsWaitingForResult">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                            <path d="M5 12h14M13 5l7 7-7 7" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                </div>
            </EditForm>
        </div>

        @if (JsonContent != null || CsvContent != null || XlsxContent != null)
        {
            <div class="chat-downloads">
                <div class="signal-actions mb-2">
                    <button class="btn btn-success me-2" @onclick="SendToApi" disabled="@IsWaitingForResult">
                        Publish to AV Engineering
                    </button>
                    <button class="btn btn-outline-danger" @onclick="ResetSession" disabled="@IsWaitingForResult">
                        Start Over
                    </button>
                </div>
                <h5>Download Generated Signal List</h5>
                <div class="download-buttons">
                    @if (JsonContent != null)
                    {
                        <button class="btn btn-outline-primary me-2" @onclick="DownloadJson">Download JSON</button>
                    }
                    @if (CsvContent != null)
                    {
                        <button class="btn btn-outline-primary me-2" @onclick="DownloadCsv">Download CSV</button>
                    }
                    @if (XlsxContent != null)
                    {
                        <button class="btn btn-outline-primary" @onclick="DownloadXlsx">Download Excel (.xlsx)</button>
                    }
                </div>
            </div>
        }
    </div>
</div>

<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        background: linear-gradient(180deg, #fff 0%, #ffe0e6 60%, #e0eaff 100%);
    }
    .chat-outer {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(180deg, #fff 0%, #ffe0e6 60%, #e0eaff 100%);
    }
    .chat-container {
        border-radius: 28px;
        box-shadow: 0 12px 48px rgba(37,99,235,0.15);
        background: #fff;
        max-width: 850px;
        width: 100%;
        min-height: 70vh;
        display: flex;
        flex-direction: column;
        padding-bottom: 0;
        position: relative;
    }
    .chat-header {
        padding: 28px 24px 16px 24px;
        border-top-left-radius: 28px;
        border-top-right-radius: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    .chat-header::after {
        content: "";
        position: absolute;
        left: 24px;
        right: 24px;
        bottom: 0;
        height: 1px;
        background: #e0e7ff;
        opacity: 0.5;
    }
    .chat-title {
        font-size: 1.5rem;
        font-weight: 800;
        letter-spacing: 1px;
    }
    .chat-messages {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        background: #f5f6fa;
    }
    .chat-downloads {
        padding: 18px 24px;
        background: #f5f6fa;
        text-align: center;
        position: relative;
        z-index: 3; /* ensure above sticky input row */
    }
    .publish-btn:not(:disabled),
    .download-buttons button:not(:disabled),
    .signal-actions button:not(:disabled),
    .chat-send-btn:not(:disabled) {
        cursor: pointer;
    }
    .signal-actions button:disabled,
    .download-buttons button:disabled,
    .chat-send-btn:disabled {
        cursor: not-allowed;
        opacity: .55;
    }
    .chat-row { display: flex; align-items: flex-end; margin-bottom: 16px; }
    .chat-user { flex-direction: row-reverse; }
    .chat-assistant { flex-direction: row; }
    .chat-avatar {
        background: #e0e7ff;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .chat-bubble {
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        border-radius: 20px;
        padding: 16px 22px;
        font-size: 1rem;
        margin: 6px 0;
        animation: fadeIn 0.4s;
    }
    .chat-user .chat-bubble {
        background: linear-gradient(90deg, #9BB4C0 80%, #4A70A9 100%);
        color: #fff;
    }
    .chat-assistant .chat-bubble { background: #e0e7ff; color: #222; }
    .chat-spinner { display: flex; align-items: center; background: #e0e7ff; color: #2563eb; }
    .chat-input-row {
        border-top: 1px solid #e5e7eb;
        background: #f5f6fa;
        padding: 18px 24px;
        box-shadow: 0 -2px 8px rgba(37,99,235,0.08);
        position: sticky;
        bottom: 0;
        z-index: 2;
    }
    .chat-input-flex { display: flex; align-items: center; gap: 12px; }
    .chat-input {
        flex: 1;
        border-radius: 24px;
        font-size: 1rem;
        padding: 14px 20px;
        height: 48px;
        box-sizing: border-box;
    }
    .chat-send-btn {
        background: linear-gradient(90deg, #2563eb 80%, #4A70A9 100%);
        box-shadow: 0 2px 8px rgba(37,99,235,0.15);
        transition: background 0.2s, transform 0.2s;
    }
    .chat-send-btn:hover:not(:disabled) {
        background: #1746a0;
        transform: scale(1.05);
    }
</style>

@code {
    private List<ChatMessage> Messages = new();
    private UserInput UserInputModel = new();
    private string SessionId = Guid.NewGuid().ToString();
    private bool IsWaitingForResult;
    private string? JsonContent;
    private string? CsvContent;
    private byte[]? XlsxContent;

    private async Task SendMessage()
    {
        var userText = UserInputModel.Text;
        if (string.IsNullOrWhiteSpace(userText)) return;

        Messages.Add(new ChatMessage { Text = userText, IsUser = true });
        UserInputModel.Text = "";
        IsWaitingForResult = true;
        StateHasChanged();

        var response = await Http.PostAsJsonAsync($"/api/chat/message?sessionId={SessionId}",
            new ChatMessageModel { UserMessage = userText });

        var result = await response.Content.ReadFromJsonAsync<ChatResponse>();
        if (result != null)
        {
            Messages.Add(new ChatMessage { Text = result.response, IsUser = false });
            if (result.isComplete)
                await PollForResult();
            else
                IsWaitingForResult = false;
        }
        else
        {
            IsWaitingForResult = false;
        }
    }

    private async Task PollForResult()
    {
        while (true)
        {
            var response = await Http.GetAsync($"/api/chat/result?sessionId={SessionId}");
            var result = await response.Content.ReadFromJsonAsync<ResultResponse>();
            if (result != null && result.ready)
            {
                var doc = System.Text.Json.JsonDocument.Parse(result.result);
                JsonContent = doc.RootElement.GetProperty("json").GetString();
                CsvContent = doc.RootElement.GetProperty("csv").GetString();
                if (doc.RootElement.TryGetProperty("xlsx", out var xProp))
                {
                    var b64 = xProp.GetString();
                    XlsxContent = !string.IsNullOrEmpty(b64) ? Convert.FromBase64String(b64) : null;
                }
                Messages.Add(new ChatMessage { Text = "Here is your generated signal list. Download below.", IsUser = false });
                IsWaitingForResult = false;
                break;
            }
            await Task.Delay(2000);
        }
    }

    private async Task ResetSession()
    {
        if (IsWaitingForResult) return;

        // Optional server-side reset if implemented (ignore errors)
        try
        {
            await Http.PostAsync("/api/signal/reset", null);
        }
        catch { /* swallow if endpoint not present */ }

        // Generate a fresh session id so server can treat next flow independently
        SessionId = Guid.NewGuid().ToString();

        Messages.Clear();
        UserInputModel = new UserInput();
        JsonContent = null;
        CsvContent = null;
        XlsxContent = null;

        // Provide a fresh initial assistant prompt (optional)
        Messages.Add(new ChatMessage
        {
            Text = "Session reset. Please describe the devices and protocol to generate a new signal list.",
            IsUser = false
        });

        StateHasChanged();
    }

    private async Task DownloadJson() =>
        await DownloadFile(JsonContent ?? "", "signal-list.json", "application/json");

    private async Task DownloadCsv() =>
        await DownloadFile(CsvContent ?? "", "signal-list.csv", "text/csv");

    private async Task DownloadXlsx()
    {
        if (XlsxContent == null) return;
        using var ms = new MemoryStream(XlsxContent);
        using var streamRef = new DotNetStreamReference(ms);
        await JS.InvokeVoidAsync("downloadFileFromStream", "signal-list.xlsx",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", streamRef);
    }

    private async Task DownloadFile(string content, string fileName, string contentType)
    {
        var bytes = System.Text.Encoding.UTF8.GetBytes(content);
        using var ms = new MemoryStream(bytes);
        using var streamRef = new DotNetStreamReference(ms);
        await JS.InvokeVoidAsync("downloadFileFromStream", fileName, contentType, streamRef);
    }

    async Task SendToApi()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(JsonContent))
            {
                Messages.Add(new ChatMessage { Text = "No JSON content to send.", IsUser = false });
                return;
            }
            var doc = System.Text.Json.JsonDocument.Parse(JsonContent);
            var response = await Http.PostAsJsonAsync("/api/Chat/SendSignalListToApi", doc.RootElement);
            if (response.IsSuccessStatusCode)
                Messages.Add(new ChatMessage { Text = "Signal list successfully published to AV Engineering!", IsUser = false });
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Messages.Add(new ChatMessage { Text = $"Error publishing: {response.StatusCode} - {errorContent}", IsUser = false });
            }
        }
        catch (Exception ex)
        {
            Messages.Add(new ChatMessage { Text = $"Exception: {ex.Message}", IsUser = false });
        }
        StateHasChanged();
    }

    [Inject] private IJSRuntime JS { get; set; } = default!;
    [Inject] private HttpClient Http { get; set; } = default!;

    private class ChatMessage
    {
        public string Text { get; set; } = "";
        public bool IsUser { get; set; }
    }

    private class UserInput
    {
        public string Text { get; set; } = "";
    }

    private class ChatResponse
    {
        public string response { get; set; } = "";
        public bool isComplete { get; set; }
    }

    private class ResultResponse
    {
        public bool ready { get; set; }
        public string result { get; set; } = "";
    }

    public class ChatMessageModel
    {
        public string UserMessage { get; set; } = "";
    }
}