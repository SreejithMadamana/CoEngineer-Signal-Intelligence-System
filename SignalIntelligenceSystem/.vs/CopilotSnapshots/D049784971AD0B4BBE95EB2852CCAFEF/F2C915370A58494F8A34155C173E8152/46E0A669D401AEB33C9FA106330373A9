using Newtonsoft.Json;
using Microsoft.AspNetCore.Mvc;
using System.Collections.Concurrent;
using System.Threading.Tasks;
using System.Collections.Generic;

[ApiController]
[Route("api/[controller]")]
public class ChatController : ControllerBase
{
    private static ConcurrentDictionary<string, ChatSessionState> _sessions = new();
    private static ConcurrentDictionary<string, string> _results = new();
    private readonly SignalOrchestratorService _signalOrchestratorService;
    private readonly OllamaService _ollamaService;

    public ChatController(
        SignalOrchestratorService signalOrchestratorService,
        OllamaService ollamaService)
    {
        _signalOrchestratorService = signalOrchestratorService;
        _ollamaService = ollamaService;
    }

    [HttpPost("message")]
    public async Task<IActionResult> PostMessage([FromQuery] string sessionId, [FromBody] string userMessage)
    {
        var session = _sessions.GetOrAdd(sessionId, _ => new ChatSessionState());
        session.Messages.Add(new LLMMessage { Role = "user", Content = userMessage });

        // Send full conversation to LLM
        var llmResponse = await _ollamaService.GetLLMChatResponseAsync(session.Messages);
        session.Messages.Add(new LLMMessage { Role = "assistant", Content = llmResponse });

        // Try to extract required info from LLM response (simple example, can be improved)
        var extracted = TryExtractSignalRequest(llmResponse);
        if (extracted != null)
        {
            session.SignalRequest = extracted;
            session.IsComplete = true;
            // Start signal list generation in the background
            _ = Task.Run(async () =>
            {
                var (success, error, response) = await _signalOrchestratorService.GenerateArtifactsAsync(session.SignalRequest);
                if (success && response != null)
                {
                    _results[sessionId] = JsonConvert.SerializeObject(new
                    {
                        json = response.JsonContent,
                        csv = response.CsvContent
                    });
                }
                else
                {
                    _results[sessionId] = JsonConvert.SerializeObject(new
                    {
                        json = $"Error: {error}",
                        csv = ""
                    });
                }
            });
        }

        _sessions[sessionId] = session;
        return Ok(new { response = llmResponse, isComplete = session.IsComplete });
    }

    [HttpGet("result")]
    public IActionResult GetResult([FromQuery] string sessionId)
    {
        if (_results.TryGetValue(sessionId, out var result))
        {
            return Ok(new { ready = true, result });
        }
        return Ok(new { ready = false, result = "" });
    }

    // Example: Try to extract SignalRequest from LLM response (improve with better parsing or LLM output format)
    private SignalRequest? TryExtractSignalRequest(string llmResponse)
    {
        // Expect LLM to return a JSON object with required fields when ready
        try
        {
            var signalRequest = JsonConvert.DeserializeObject<SignalRequest>(llmResponse);
            if (signalRequest != null && !string.IsNullOrEmpty(signalRequest.DeviceType) &&
                !string.IsNullOrEmpty(signalRequest.Protocol) && signalRequest.DeviceCount > 0)
            {
                return signalRequest;
            }
        }
        catch { }
        return null;
    }
}