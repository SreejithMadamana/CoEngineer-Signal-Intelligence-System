@page "/chatbot"
@using System.Net.Http.Json

<div class="chat-container">
 <div class="chat-header">
 <span class="chat-title">Signal Intelligence Copilot</span>
 </div>
 <div class="chat-messages">
 @for (int i =0; i < Messages.Count; i++)
 {
 <div class="chat-row @(Messages[i].IsUser ? "chat-user" : "chat-assistant")">
 <div class="chat-avatar">
 <span class="avatar-icon">@(Messages[i].IsUser ? "🧑" : "🤖")</span>
 </div>
 <div class="chat-bubble">@Messages[i].Text</div>
 </div>
 }
 @if (IsWaitingForResult)
 {
 <div class="chat-row chat-assistant">
 <div class="chat-avatar"><span class="avatar-icon">🤖</span></div>
 <div class="chat-bubble chat-spinner">
 <span class="spinner-border spinner-border-sm text-primary"></span>
 <span class="ms-2">Generating signal list, please wait...</span>
 </div>
 </div>
 }
 </div>
 <div class="chat-input-row">
 <EditForm Model="@UserInputModel" OnValidSubmit="@(() => SendMessage())">
 <div class="input-group">
 <InputText @bind-value="UserInputModel.Text" class="form-control chat-input" placeholder="Type your message..." disabled="@IsWaitingForResult" />
 <button type="submit" class="btn btn-primary chat-send-btn" disabled="@IsWaitingForResult">Send</button>
 </div>
 </EditForm>
 </div>
 @if (JsonContent != null || CsvContent != null)
 {
 <div class="chat-downloads">
 <h5>Download Generated Signal List</h5>
 @if (JsonContent != null)
 {
 <button class="btn btn-outline-primary me-2" @onclick="DownloadJson">Download JSON</button>
 }
 @if (CsvContent != null)
 {
 <button class="btn btn-outline-primary" @onclick="DownloadCsv">Download CSV</button>
 }
 </div>
 }
</div>

<style>
.chat-container {
 max-width:600px;
 margin:40px auto;
 background: #fff;
 border-radius:12px;
 box-shadow:02px16px rgba(0,0,0,0.08);
 display: flex;
 flex-direction: column;
 min-height:70vh;
 padding:0;
}
.chat-header {
 background: #2563eb;
 color: #fff;
 padding:18px24px;
 border-top-left-radius:12px;
 border-top-right-radius:12px;
 font-size:1.2rem;
 font-weight:600;
 letter-spacing:1px;
}
.chat-title {
 font-size:1.2rem;
}
.chat-messages {
 flex:1;
 padding:24px;
 overflow-y: auto;
 background: #f5f6fa;
}
.chat-row {
 display: flex;
 align-items: flex-end;
 margin-bottom:16px;
}
.chat-user {
 flex-direction: row-reverse;
}
.chat-assistant {
 flex-direction: row;
}
.chat-avatar {
 width:36px;
 height:36px;
 display: flex;
 align-items: center;
 justify-content: center;
 font-size:1.5rem;
 margin:08px;
}
.chat-bubble {
 max-width:70%;
 padding:12px18px;
 border-radius:18px;
 font-size:1rem;
 background: #e0e7ff;
 color: #222;
 box-shadow:01px4px rgba(0,0,0,0.04);
 word-break: break-word;
}
.chat-user .chat-bubble {
 background: #2563eb;
 color: #fff;
 border-bottom-right-radius:4px;
 border-bottom-left-radius:18px;
}
.chat-assistant .chat-bubble {
 background: #e0e7ff;
 color: #222;
 border-bottom-left-radius:4px;
 border-bottom-right-radius:18px;
}
.chat-spinner {
 display: flex;
 align-items: center;
 background: #e0e7ff;
 color: #2563eb;
}
.chat-input-row {
 padding:18px24px;
 border-top:1px solid #e5e7eb;
 background: #f5f6fa;
 border-bottom-left-radius:12px;
 border-bottom-right-radius:12px;
}
.chat-input {
 border-radius:18px0018px;
 font-size:1rem;
 padding:10px16px;
}
.chat-send-btn {
 border-radius:018px18px0;
 font-size:1rem;
 padding:10px24px;
}
.chat-downloads {
 padding:18px24px;
 background: #f5f6fa;
 border-bottom-left-radius:12px;
 border-bottom-right-radius:12px;
}
</style>

@code {
 private List<ChatMessage> Messages = new();
 private UserInput UserInputModel = new();
 private string SessionId = Guid.NewGuid().ToString();
 private bool IsWaitingForResult = false;
 private string? FinalResult = null;
 private string? JsonContent = null;
 private string? CsvContent = null;

 private async Task SendMessage()
 {
 var userText = UserInputModel.Text;
 if (string.IsNullOrWhiteSpace(userText)) return;
 Messages.Add(new ChatMessage { Text = userText, IsUser = true });
 UserInputModel.Text = "";
 IsWaitingForResult = true;
 StateHasChanged();

 var response = await Http.PostAsJsonAsync($"/api/chat/message?sessionId={SessionId}", userText);
 var result = await response.Content.ReadFromJsonAsync<ChatResponse>();

 if (result != null)
 {
 Messages.Add(new ChatMessage { Text = result.response, IsUser = false });
 if (result.isComplete)
 {
 await PollForResult();
 }
 else
 {
 IsWaitingForResult = false;
 }
 }
 else
 {
 IsWaitingForResult = false;
 }
 }

 private async Task PollForResult()
 {
 while (true)
 {
 var response = await Http.GetAsync($"/api/chat/result?sessionId={SessionId}");
 var result = await response.Content.ReadFromJsonAsync<ResultResponse>();
 if (result != null && result.ready)
 {
 var doc = System.Text.Json.JsonDocument.Parse(result.result);
 JsonContent = doc.RootElement.GetProperty("json").GetString();
 CsvContent = doc.RootElement.GetProperty("csv").GetString();
 FinalResult = "Ready";
 Messages.Add(new ChatMessage { Text = "Here is your generated signal list. Download below.", IsUser = false });
 IsWaitingForResult = false;
 break;
 }
 await Task.Delay(2000);
 }
 }

 private async Task DownloadJson()
 {
 await DownloadFile(JsonContent ?? "", "signal-list.json", "application/json");
 }

 private async Task DownloadCsv()
 {
 await DownloadFile(CsvContent ?? "", "signal-list.csv", "text/csv");
 }
 private async Task DownloadFile(string content, string fileName, string contentType)
 {
 var bytes = System.Text.Encoding.UTF8.GetBytes(content);
 using var stream = new MemoryStream(bytes);
 using var streamRef = new Microsoft.JSInterop.DotNetStreamReference(stream);
 await JS.InvokeVoidAsync("downloadFileFromStream", fileName, contentType, streamRef);
 }

 [Inject] private IJSRuntime JS { get; set; } = default!;
 [Inject] private HttpClient Http { get; set; } = default!;

 private class ChatMessage
 {
 public string Text { get; set; } = "";
 public bool IsUser { get; set; }
 }

 private class UserInput
 {
 public string Text { get; set; } = "";
 }

 private class ChatResponse
 {
 public string response { get; set; } = "";
 public bool isComplete { get; set; }
 }

 private class ResultResponse
 {
 public bool ready { get; set; }
 public string result { get; set; } = "";
 public string jsonContent { get; set; } = "";
 public string csvContent { get; set; } = "";
 }
}
